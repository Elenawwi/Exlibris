{% extends 'Exlib_app/base.html' %}

{% block content %}
<div class="container mx-auto px-4 lg:px-8 max-w-6xl py-8">
    
    <!-- Заголовок -->
    <div class="mb-8">
        <h1 class="font-display font-extrabold text-4xl mb-2">МОЙ ПРОФИЛЬ</h1>
        <p class="text-gray-600">Управляйте своим аккаунтом и отслеживайте прогресс</p>
    </div>
    
    {% if user.is_authenticated %}
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
        <!-- Информация профиля -->
        <div class="lg:col-span-1">
            <div class="bg-white border-2 border-brut-black rounded-xl p-6 shadow-hard mb-6">
                <!-- Аватар -->
                <div class="flex flex-col items-center mb-6">
                    <div class="w-32 h-32 bg-soft-lime rounded-full border-4 border-brut-black overflow-hidden mb-4">
                        {% if user_profile.avatar %}
                            <img src="{{ user_profile.avatar.url }}" 
                                 alt="{{ user.username }}"
                                 class="w-full h-full object-cover">
                        {% else %}
                            <div class="w-full h-full flex items-center justify-center text-4xl font-bold">
                                {{ user.username|first|upper }}
                            </div>
                        {% endif %}
                    </div>
                    <h2 class="font-bold text-2xl">{{ user.username }}</h2>
                    <p class="text-gray-600">Участник сообщества</p>
                    
                    <div class="mt-4 flex items-center gap-2">
                        <span class="px-3 py-1 bg-yellow-100 text-yellow-800 rounded-full text-sm font-bold">
                            <i class="fa-solid fa-star mr-1"></i>
                            {{ user_profile.karma|default:0 }} кармы
                        </span>
                    </div>
                </div>
                
                <!-- Статистика -->
                <div class="space-y-4">
                    <div class="flex justify-between items-center">
                        <span class="text-gray-600">Дата регистрации:</span>
                        <span class="font-bold">{{ user.date_joined|date:"d.m.Y" }}</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-gray-600">Постов на форуме:</span>
                        <span class="font-bold">{{ forum_posts_count|default:0 }}</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-gray-600">Комментариев:</span>
                        <span class="font-bold">{{ comments_count|default:0 }}</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-gray-600">Книг в закладках:</span>
                        <span class="font-bold">{{ bookmarks_count|default:0 }}</span>
                    </div>
                </div>
                
                <!-- Кнопки -->
                <div class="mt-6 space-y-3">
                    <a href="{% url 'bookmarks' %}" 
                       class="block w-full bg-white text-brut-black py-3 rounded-lg border-2 border-brut-black font-bold text-center hover:bg-soft-lime transition-colors">
                        Мои закладки
                    </a>
                    <button class="w-full bg-white text-brut-black py-3 rounded-lg border-2 border-brut-black font-bold hover:bg-gray-100 transition-colors">
                        Редактировать профиль
                    </button>
                    <a href="/admin/logout/" 
                       class="block w-full bg-red-100 text-red-700 py-3 rounded-lg border-2 border-red-300 font-bold text-center hover:bg-red-200 transition-colors">
                        Выйти
                    </a>
                </div>
            </div>
            
            <!-- Книжный марафон -->
            {% if reading_challenge %}
            <div class="bg-soft-pink border-2 border-brut-black rounded-xl p-5 shadow-hard">
                <h3 class="font-bold text-lg mb-4 flex items-center gap-2">
                    <i class="fa-solid fa-trophy"></i>
                    Книжный марафон {{ reading_challenge.year }}
                </h3>
                <div class="mb-4">
                    <div class="text-sm mb-2 font-medium">
                        Прочитано {{ reading_challenge.current }}/{{ reading_challenge.goal }} книг
                    </div>
                    <div class="w-full bg-white border-2 border-brut-black h-3 rounded-full overflow-hidden mb-1">
                        <div class="progress-bar bg-brut-black h-full" 
                            data-progress="{{ reading_challenge.progress_percentage }}"
                            id="profile-progress-bar">
                        </div>
                    </div>
                    <div class="text-xs text-right">{{ reading_challenge.progress_percentage }}%</div>
                </div>
                <button class="w-full bg-white text-brut-black py-2 rounded-lg border-2 border-brut-black font-bold hover:bg-brut-black hover:text-white transition-colors">
                    Обновить прогресс
                </button>
            </div>
            {% endif %}
        </div>
        
        <!-- Основной контент -->
        <div class="lg:col-span-2">
            <!-- Мои книги -->
            <div class="bg-white border-2 border-brut-black rounded-xl p-6 shadow-hard mb-6">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="font-bold text-xl">Мои книги</h3>
                    <a href="{% url 'bookmarks' %}" class="text-sm font-bold text-brut-black hover:text-purple-700">
                        Все книги →
                    </a>
                </div>
                
                {% if user_books %}
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
                    {% for user_book in user_books|slice:":6" %}
                    <div class="border-2 border-brut-black rounded-lg p-3">
                        <a href="{% url 'book_detail' user_book.book.slug %}">
                            <div class="aspect-[2/3] bg-gray-200 rounded-lg border-2 border-brut-black overflow-hidden mb-2">
                                {% if user_book.book.cover_image %}
                                    <img src="{{ user_book.book.cover_image.url }}" 
                                         alt="{{ user_book.book.title }}"
                                         class="w-full h-full object-cover">
                                {% else %}
                                    <div class="w-full h-full flex items-center justify-center">
                                        <i class="fas fa-book text-2xl text-gray-400"></i>
                                    </div>
                                {% endif %}
                            </div>
                        </a>
                        <h4 class="font-bold text-sm truncate">{{ user_book.book.title }}</h4>
                        <div class="flex justify-between items-center mt-2">
                            <span class="text-xs px-2 py-1 rounded {% if user_book.status == 'reading' %}bg-brut-black text-white{% elif user_book.status == 'planned' %}bg-blue-100 text-blue-800{% elif user_book.status == 'read' %}bg-purple-100 text-purple-800{% else %}bg-gray-100{% endif %}">
                                {{ user_book.get_status_display }}
                            </span>
                            <span class="text-xs text-gray-500">{{ user_book.added_at|date:"d.m" }}</span>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <div class="text-center py-8">
                    <i class="fas fa-book-open text-3xl text-gray-400 mb-3"></i>
                    <p class="text-gray-600 mb-4">У вас пока нет книг в закладках</p>
                    <a href="{% url 'book_list' %}" 
                       class="inline-block bg-brut-black text-white px-4 py-2 rounded-lg border-2 border-brut-black font-bold hover:bg-soft-lime hover:text-brut-black transition-colors text-sm">
                        Найти книги
                    </a>
                </div>
                {% endif %}
            </div>
            
            <!-- Мои посты -->
            <div class="bg-white border-2 border-brut-black rounded-xl p-6 shadow-hard">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="font-bold text-xl">Мои последние посты</h3>
                    <a href="{% url 'forum' %}" class="text-sm font-bold text-brut-black hover:text-purple-700">
                        Все посты →
                    </a>
                </div>
                
                {% if user_forum_posts %}
                <div class="space-y-4">
                    {% for post in user_forum_posts|slice:":5" %}
                    <a href="{% url 'forum_post_detail' post.id %}" 
                       class="block p-4 border-2 border-brut-black rounded-lg hover:bg-gray-50 transition-colors">
                        <div class="flex justify-between items-start mb-2">
                            <span class="text-xs px-2 py-1 bg-gray-100 rounded">
                                {{ post.get_category_display }}
                            </span>
                            <span class="text-xs text-gray-500">{{ post.created_at|date:"d.m.Y" }}</span>
                        </div>
                        <h4 class="font-bold mb-1">{{ post.title|truncatechars:60 }}</h4>
                        <p class="text-sm text-gray-600">{{ post.content|truncatechars:80 }}</p>
                        <div class="flex items-center gap-4 mt-3 text-xs text-gray-500">
                            <span><i class="fa-regular fa-eye mr-1"></i> {{ post.views }}</span>
                            <span><i class="fa-regular fa-heart mr-1"></i> {{ post.likes }}</span>
                        </div>
                    </a>
                    {% endfor %}
                </div>
                {% else %}
                <div class="text-center py-8">
                    <i class="fas fa-comment text-3xl text-gray-400 mb-3"></i>
                    <p class="text-gray-600 mb-4">Вы еще не создавали посты на форуме</p>
                    <a href="{% url 'create_forum_post' %}" 
                       class="inline-block bg-brut-black text-white px-4 py-2 rounded-lg border-2 border-brut-black font-bold hover:bg-soft-lime hover:text-brut-black transition-colors text-sm">
                        Создать пост
                    </a>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
    
    {% else %}
    <!-- Неавторизованный пользователь -->
    <div class="bg-white border-2 border-brut-black rounded-xl p-12 text-center">
        <i class="fas fa-user text-5xl text-gray-400 mb-4"></i>
        <h3 class="font-bold text-xl mb-2">Доступно только авторизованным пользователям</h3>
        <p class="text-gray-600 mb-8">Войдите, чтобы просматривать свой профиль и управлять закладками</p>
        
        <div class="flex flex-col sm:flex-row gap-4 justify-center">
            <a href="/admin/login/" 
               class="bg-brut-black text-white px-6 py-3 rounded-lg border-2 border-brut-black font-bold hover:bg-soft-lime hover:text-brut-black transition-colors">
                Войти
            </a>
            <a href="{% url 'book_list' %}" 
               class="bg-white text-brut-black px-6 py-3 rounded-lg border-2 border-brut-black font-bold hover:bg-soft-purple transition-colors">
                Перейти к книгам
            </a>
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}